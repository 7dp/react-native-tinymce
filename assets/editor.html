<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="user-scalable=no, width=device-width">

	<style>
		html, body {
			height: 100%;
			margin: 0;
		}

		form,
		#editor {
			height: 100%;
		}

		::selection {
			background-color: rebeccapurple;
		}
	</style>
</head>

<body>
	<form method="post">
		<textarea id="editor">Hello, World!</textarea>
	</form>

<script src="https://cdn.jsdelivr.net/npm/tinymce@5.1.5/tinymce.js" referrerpolicy="origin"></script>
<script>
	let status = {
		bold: false,
		italic: false,
		underline: false,
		strikethrough: false,
		paraType: 'p',
	};
	const sendStatus = () => {
		if ( window.ReactNativeWebView ) {
			window.ReactNativeWebView.postMessage( JSON.stringify( {
				type: 'updateStatus',
				payload: status,
			} ) );
		} else {
			console.log( status );
		}
	};

	tinymce.init( {
		target: document.getElementById( 'editor' ),
		menubar: false,
		statusbar: false,
		toolbar: false,

		// No need for inputs.
		hidden_input: false,

		// Add some basic plugins.
		plugins: [
			'lists',
		],
	} ).then( editors => {
		const editor = editors[0];
		window.tinyEditor = editor;

		editor.on( 'NodeChange', ( api ) => {
			// Find the nearest list item.
			for ( let i = 0; i < api.parents.length; i++ ) {
				if ( api.parents[ i ].tagName !== 'LI' ) {
					continue;
				}

				// Found a list item, check the parent.
				const parentIndex = i + 1;
				if ( parentIndex >= api.parents.length ) {
					console.log( parentIndex );
					continue;
				}
				const parent = api.parents[ parentIndex ];
				switch ( parent.tagName ) {
					case 'UL':
					case 'OL':
						status = {
							...status,
							paraType: parent.tagName.toLowerCase(),
						};
						sendStatus();
						break;
				}
			}
		} );

		const formats = [
			'bold',
			'italic',
			'underline',
			'strikethrough',
		];
		formats.forEach( format => {
			editor.formatter.formatChanged( format, value => {
				status = {
					...status,
					[ format ]: value,
				};
				sendStatus();
			}, true );
		} );

		const paraType = [
			'p',
			'blockquote',
			'h1',
			'h2',
			'pre',
			'UL',
			'OL',
		];
		paraType.forEach( type => {
			editor.formatter.formatChanged( type, value => {
				if ( ! value ) {
					return;
				}

				status = {
					...status,
					paraType: type,
				};
				sendStatus();
			} );
		} );
	} );
</script>
</body>
</html>
